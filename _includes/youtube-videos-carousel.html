{% comment %}
  Horizontal scrollable carousel for YouTube videos
  Usage (with playlist ID - auto-fetches from RSS):
    {% include youtube-videos-carousel.html
       playlist_id="PLLQlZaiiGlHOdfqGoErLQaMaDPZdHARVV"
    %}

  Or Usage (with manual video IDs):
    {% include youtube-videos-carousel.html
       video_ids="j05gGT3xfCs,VIDEO_ID_2,VIDEO_ID_3"
    %}
{% endcomment %}

{% if include.video_ids %}
  {% assign videos = include.video_ids | split: "," %}
{% endif %}

<div class="youtube-videos-carousel-wrapper full-width" {% if include.playlist_id %}data-playlist-id="{{ include.playlist_id }}"{% endif %}>
  <div class="youtube-videos-carousel">
    {% if include.video_ids %}
    {% for video_id in videos %}
    <div class="youtube-video-card">
      <div class="video-skeleton"></div>
      <iframe
        class="video-iframe"
        src="https://www.youtube.com/embed/{{ video_id | strip }}"
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin"
        allowfullscreen
        loading="lazy">
      </iframe>
    </div>
    {% endfor %}
    {% else %}
    <!-- Videos will be loaded dynamically from playlist -->
    <div class="loading-placeholder">
      <div class="spinner"></div>
      <p>Loading videos from playlist...</p>
    </div>
    {% endif %}
  </div>
  <div class="carousel-hint">← Scroll to explore more videos →</div>
</div>

<style>
.youtube-videos-carousel-wrapper {
  margin: 2rem 0;
  width: 100%;
}

.youtube-videos-carousel-wrapper.full-width {
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -30vw;
  margin-right: -30vw;
  box-sizing: border-box;
  overflow: hidden;
  background-color: #f2f2f2;
  border-radius: 24px;
  padding-top: 2rem;
  padding-bottom: 2rem;
}

.youtube-videos-carousel {
  display: flex;
  gap: 1.5rem;
  overflow-x: auto;
  scroll-behavior: smooth;
  padding: 1rem 2rem 1.5rem 2rem;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: #888 #f1f1f1;
  align-items: flex-start;
}

.youtube-videos-carousel-wrapper.full-width .youtube-videos-carousel {
  padding-left: max(2rem, calc(50vw - 600px));
  padding-right: max(2rem, calc(50vw - 600px));
}

.youtube-videos-carousel-wrapper.full-width .carousel-hint {
  padding-left: max(2rem, calc(50vw - 600px));
  padding-right: max(2rem, calc(50vw - 600px));
}

.youtube-videos-carousel::-webkit-scrollbar {
  height: 8px;
}

.youtube-videos-carousel::-webkit-scrollbar-track {
  background: #e0e0e0;
  border-radius: 10px;
}

.youtube-videos-carousel::-webkit-scrollbar-thumb {
  background: #999;
  border-radius: 10px;
}

.youtube-videos-carousel::-webkit-scrollbar-thumb:hover {
  background: #666;
}

.youtube-video-card {
  flex: 0 0 400px;
  min-width: 400px;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  aspect-ratio: 16 / 9;
  height: 225px;
}

.youtube-video-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

/* Loading placeholder */
.loading-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 225px;
  color: #666;
}

.spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #666;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin-bottom: 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Skeleton Loader */
.video-skeleton {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, #e8e8e8 25%, #d8d8d8 50%, #e8e8e8 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  z-index: 1;
}

@keyframes loading {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

.video-iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  z-index: 2;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.youtube-video-card.loaded .video-skeleton {
  display: none;
}

.youtube-video-card.loaded .video-iframe {
  opacity: 1;
}

.carousel-hint {
  text-align: center;
  color: #999;
  font-size: 0.85rem;
  margin-top: 0.5rem;
  font-style: italic;
  padding: 0 2rem;
}

@media (max-width: 768px) {
  .youtube-videos-carousel-wrapper.full-width {
    border-radius: 16px;
    padding-top: 1.5rem;
    padding-bottom: 1.5rem;
  }

  .youtube-videos-carousel {
    padding: 1rem 1rem 1.5rem 1rem;
  }

  .carousel-hint {
    padding: 0 1rem;
  }

  .youtube-video-card {
    flex: 0 0 90vw;
    min-width: 90vw;
    height: auto;
  }
}
</style>

<script>
(function() {
  'use strict';

  // Fetch videos from YouTube RSS feed
  async function fetchPlaylistVideos(playlistId) {
    const rssUrl = `https://www.youtube.com/feeds/videos.xml?playlist_id=${playlistId}`;

    try {
      const response = await fetch(rssUrl);
      const xmlText = await response.text();

      // Parse XML and extract video IDs
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

      // Check for parsing errors
      const parserError = xmlDoc.querySelector('parsererror');
      if (parserError) {
        throw new Error('XML parsing error');
      }

      // Extract video IDs from yt:videoId elements
      const videoIds = [];
      const entries = xmlDoc.querySelectorAll('entry');

      entries.forEach(entry => {
        const videoIdElement = entry.querySelector('videoId');
        if (videoIdElement) {
          videoIds.push(videoIdElement.textContent);
        }
      });

      return videoIds;
    } catch (error) {
      console.error('Error fetching playlist:', error);
      return [];
    }
  }

  // Create video card HTML
  function createVideoCard(videoId) {
    const card = document.createElement('div');
    card.className = 'youtube-video-card';
    card.innerHTML = `
      <div class="video-skeleton"></div>
      <iframe
        class="video-iframe"
        src="https://www.youtube.com/embed/${videoId}"
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin"
        allowfullscreen
        loading="lazy">
      </iframe>
    `;

    // Add load event listener
    const iframe = card.querySelector('.video-iframe');
    iframe.addEventListener('load', function() {
      card.classList.add('loaded');
    });

    // Fallback timeout
    setTimeout(() => {
      card.classList.add('loaded');
    }, 2000);

    return card;
  }

  // Initialize carousel
  async function initializeCarousel() {
    const wrappers = document.querySelectorAll('.youtube-videos-carousel-wrapper[data-playlist-id]');

    for (const wrapper of wrappers) {
      const playlistId = wrapper.getAttribute('data-playlist-id');
      const carousel = wrapper.querySelector('.youtube-videos-carousel');
      const placeholder = carousel.querySelector('.loading-placeholder');

      if (playlistId && placeholder) {
        const videoIds = await fetchPlaylistVideos(playlistId);

        if (videoIds.length > 0) {
          // Remove placeholder
          placeholder.remove();

          // Add video cards
          videoIds.forEach(videoId => {
            const card = createVideoCard(videoId);
            carousel.appendChild(card);
          });
        } else {
          placeholder.innerHTML = '<p>Failed to load videos. Please try again later.</p>';
        }
      }
    }

    // Handle manually added videos (not from playlist)
    const videoCards = document.querySelectorAll('.youtube-video-card');
    videoCards.forEach(card => {
      const iframe = card.querySelector('.video-iframe');
      if (iframe && !iframe.hasAttribute('data-listener')) {
        iframe.setAttribute('data-listener', 'true');
        iframe.addEventListener('load', function() {
          card.classList.add('loaded');
        });

        setTimeout(() => {
          card.classList.add('loaded');
        }, 2000);
      }
    });
  }

  // Run on DOM content loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCarousel);
  } else {
    initializeCarousel();
  }
})();
</script>